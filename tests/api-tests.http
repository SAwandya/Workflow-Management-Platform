### ============================================
### WMC Phase 2 - API Tests
### Use REST Client extension in VS Code
### ============================================

### Variables
@workflowService = http://localhost:3006
@integrationService = http://localhost:3005
@tenantManager = http://localhost:3002
@productService = http://localhost:3001
@apiGateway = http://localhost:3000
@tenantId = tenant-a

### ============================================
### WORKFLOW SERVICE TESTS
### ============================================

### 1. Health Check - Workflow Service
GET {{workflowService}}/health

### 2. List All Workflows
GET {{workflowService}}/api/workflows
X-Tenant-ID: {{tenantId}}

### 3. Create New Workflow
# @name createWorkflow
POST {{workflowService}}/api/workflows
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "name": "Test Workflow via REST Client",
  "description": "Created using VS Code REST Client",
  "steps_json": {
    "steps": [
      {
        "step_id": "1",
        "step_name": "start",
        "type": "start-event",
        "next": "2"
      },
      {
        "step_id": "2",
        "step_name": "process-order",
        "type": "service-task",
        "action": "api-call",
        "config": {
          "method": "GET",
          "endpoint": "/api/orders/{orderId}",
          "output_variable": "orderDetails"
        },
        "next": "3"
      },
      {
        "step_id": "3",
        "step_name": "end",
        "type": "end-event"
      }
    ]
  },
  "created_by": "rest-client-tester"
}

### 4. Get Specific Workflow (use workflow_id from previous response)
GET {{workflowService}}/api/workflows/wf-1764691066254-g13neh
X-Tenant-ID: {{tenantId}}

### 5. Update Workflow
PUT {{workflowService}}/api/workflows/wf-1764691066254-g13neh
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "name": "Updated Workflow Name",
  "description": "Updated description"
}

### 6. Submit Workflow for Approval
POST {{workflowService}}/api/workflows/wf-1764688391766-bnbz6k/submit
X-Tenant-ID: {{tenantId}}

### 7. Approve Workflow
POST {{workflowService}}/api/workflows/wf-1764838349226-dcc3l0/approve
X-Tenant-ID: {{tenantId}}

### 8. Reject Workflow
POST {{workflowService}}/api/workflows/wf-1764688391766-bnbz6k/reject
X-Tenant-ID: {{tenantId}}

### 9. Delete Workflow
DELETE {{workflowService}}/api/workflows/wf-1764688391766-bnbz6k
X-Tenant-ID: {{tenantId}}

### ============================================
### SERVICE CATALOG TESTS
### ============================================

### 10. List All Services
GET {{integrationService}}/api/services/catalog

### 11. Get Service Categories
GET {{integrationService}}/api/services/catalog/categories

### 12. Filter by Category
GET {{integrationService}}/api/services/catalog?category=product_api

### 13. Search Services
GET {{integrationService}}/api/services/catalog?search=stripe

### 14. Get Service Schema
GET {{integrationService}}/api/services/catalog/product.orders.get/schema

### 15. Create Custom Service
POST {{integrationService}}/api/services/custom
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "name": "My Custom API",
  "description": "Custom service for testing",
  "endpoint_url": "https://api.example.com/test",
  "authentication_type": "api_key",
  "parameters_schema": {
    "type": "object",
    "properties": {
      "api_key": {
        "type": "string",
        "title": "API Key",
        "ui_component": "secret_input",
        "required": true
      }
    }
  }
}

### 16. List Custom Services
GET {{integrationService}}/api/services/custom
X-Tenant-ID: {{tenantId}}

### ============================================
### TENANT MANAGER TESTS
### ============================================

### 17. List All Tenants
GET {{tenantManager}}/api/tenants

### 18. Register Workflow in Tenant Manager
POST {{tenantManager}}/api/tenants/{{tenantId}}/workflows
Content-Type: application/json

{
  "workflow_id": "wf-1764838349226-dcc3l0",
  "workflow_name": "Customer Order Workflow",
  "trigger_type": "sync",
  "trigger_event": "ORDER_CREATED"
}

### 19. List Tenant Workflows
GET {{tenantManager}}/api/tenants/{{tenantId}}/workflows

### 20. Query Workflow by Event
GET {{tenantManager}}/api/tenants/{{tenantId}}/workflows/query?trigger_event=ORDER_CREATED

### Delete Registered Workflow
# Replace registry_id with actual value from #19 response
DELETE {{tenantManager}}/api/tenants/{{tenantId}}/workflows/1

### ============================================
### PRODUCT SERVICE TESTS (Trigger Workflows)
### ============================================

### 21. Create Order (Triggers Workflow)
# @name createOrder
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "customer_id": "cust-rest-client-test",
  "items": [
    {
      "product": "Test Product",
      "quantity": 1,
      "price": 15000
    }
  ],
  "total": 15000
}

### 22. List All Orders
GET {{productService}}/api/orders
X-Tenant-ID: {{tenantId}}

### 23. Get Specific Order
GET {{productService}}/api/orders/ord-abc123
X-Tenant-ID: {{tenantId}}

### ============================================
### API GATEWAY TESTS (Workflow Execution)
### ============================================

### 24. Get Workflow Instance Status
# Use instanceId from createOrder response
GET {{apiGateway}}/api/gateway/workflows/instances/inst-d6734538-47f3-4fd2-ade2-0daac099633a/status?tenant_id={{tenantId}}

### 25. Resume Workflow (For User Tasks)
POST {{apiGateway}}/api/gateway/workflows/instances/inst-d6734538-47f3-4fd2-ade2-0daac099633a/resume
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "step_id": "5",
  "user_input": {
    "approved": true,
    "approver": "manager@tenant-a.com",
    "comments": "Approved via REST Client"
  }
}

### ============================================
### INTEGRATION SERVICE TESTS
### ============================================

### 26. Test API Call Directly
POST {{integrationService}}/api/integration/api-call
Content-Type: application/json

{
  "method": "GET",
  "endpoint": "http://product-service:3000/api/orders",
  "headers": {
    "X-Tenant-ID": "tenant-a"
  }
}

### 27. Test Notification
POST {{integrationService}}/api/integration/notification
Content-Type: application/json

{
  "channel": "email",
  "recipient": "test@example.com",
  "template": "order-approval-request",
  "data": {
    "orderId": "test-order-123",
    "orderValue": 15000
  }
}

### ============================================
### HEALTH CHECKS (All Services)
### ============================================

### 28. Check All Services
GET {{productService}}/health
###
GET {{tenantManager}}/health
###
GET {{apiGateway}}/health
###
GET {{workflowService}}/health
###
GET {{integrationService}}/health

### ============================================
### COMPLETE WORKFLOW FLOW TESTS
### ============================================

### 29. Verify Workflow Registration
# Check if workflow is registered for ORDER_CREATED event
GET {{tenantManager}}/api/tenants/{{tenantId}}/workflows/query?trigger_event=ORDER_UPDATED


### 30. Create High-Value Order (Triggers Workflow - Requires Approval)
# @name createHighValueOrder
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "customer_id": "customer-high-value-001",
  "items": [
    {
      "product": "Enterprise Server Dell PowerEdge R750",
      "quantity": 2,
      "price": 8000
    }
  ],
  "total": 16000
}

### 31. Create Low-Value Order (Triggers Workflow - Auto-Approved)
# @name createLowValueOrder
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "customer_id": "customer-low-value-001",
  "items": [
    {
      "product": "Wireless Mouse Logitech MX",
      "quantity": 10,
      "price": 50
    }
  ],
  "total": 500
}

### 32. Get Workflow Instance Status (High-Value Order)
# Copy instanceId from createHighValueOrder response
# Replace INSTANCE-ID with actual instanceId
GET {{apiGateway}}/api/gateway/workflows/instances/INSTANCE-ID/status?tenant_id={{tenantId}}

### 33. Get All Recent Workflow Instances
GET {{apiGateway}}/api/gateway/workflows/instances/recent?tenant_id={{tenantId}}&limit=10

### 34. Approve Workflow (Manager Action)
# Copy instanceId and current_step from status response
# Replace INSTANCE-ID with actual instanceId
POST {{apiGateway}}/api/gateway/workflows/instances/INSTANCE-ID/resume
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "step_id": "5",
  "user_input": {
    "approved": true,
    "approver": "manager@tenant-a.com",
    "approved_at": "2025-12-04T10:00:00Z",
    "comments": "Order approved - Customer has good credit history"
  }
}

### 35. Reject Workflow (Manager Action)
# Copy instanceId from status response
# Replace INSTANCE-ID with actual instanceId
POST {{apiGateway}}/api/gateway/workflows/instances/INSTANCE-ID/resume
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "step_id": "5",
  "user_input": {
    "approved": false,
    "approver": "manager@tenant-a.com",
    "rejected_at": "2025-12-04T10:00:00Z",
    "comments": "Order rejected - Budget exceeded"
  }
}

### 36. Check Order Status After Approval
# Replace ORDER-ID with actual order_id
GET {{productService}}/api/orders/ORDER-ID
X-Tenant-ID: {{tenantId}}

### 37. List All Orders for Tenant
GET {{productService}}/api/orders
X-Tenant-ID: {{tenantId}}

### ============================================
### BATCH TESTING - Create Multiple Orders
### ============================================

### 38. Create Order Batch 1 - High Value
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "customer_id": "batch-customer-001",
  "items": [{"product": "HP ProLiant Server", "quantity": 1, "price": 12000}],
  "total": 12000
}

### 39. Create Order Batch 2 - High Value
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "customer_id": "batch-customer-002",
  "items": [{"product": "Cisco Network Switch", "quantity": 3, "price": 5000}],
  "total": 15000
}

### 40. Create Order Batch 3 - Low Value
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}

{
  "customer_id": "batch-customer-003",
  "items": [{"product": "USB Cable", "quantity": 50, "price": 10}],
  "total": 500
}

### ============================================
### DATABASE VERIFICATION QUERIES
### ============================================

### 41. Get All Workflow Instances from Database
# Run this in PostgreSQL CLI:
# docker exec -it wmc-postgresql psql -U wmc_admin -d wmc_platform
# SELECT instance_id, workflow_id, status, started_at, completed_at 
# FROM execution_repository.workflow_instances 
# WHERE tenant_id = 'tenant-a' 
# ORDER BY started_at DESC LIMIT 10;

### 42. Get Step History for Instance
# Run this in PostgreSQL CLI:
# SELECT sh.step_id, sh.step_name, sh.step_type, sh.status, sh.started_at, sh.completed_at
# FROM execution_repository.step_history sh
# WHERE sh.instance_id = 'INSTANCE-ID'
# ORDER BY sh.started_at ASC;

### ============================================
### WORKFLOW EXECUTION DEBUG
### ============================================

### 43. Check Workflow Definition
# Replace WORKFLOW-ID with your workflow_id
GET {{workflowService}}/api/workflows/wf-1764838349226-dcc3l0
X-Tenant-ID: {{tenantId}}

### 44. Verify Workflow Has User Task
# Check the response from #43 - should have a step with type: "user-task"
# Look for: "step_id": "5", "type": "user-task"

### 45. Check Product Service Logs
# Run in terminal:
# docker logs wmc-product-service --tail 50 | grep -i "workflow"

### 46. Check Execution Service Logs
# Run in terminal:
# docker logs wmc-execution-service --tail 50 | grep -i "user task"

### ============================================
### COMPLETE FLOW TEST SEQUENCE
### ============================================

### STEP 1: Verify Setup
### Run #29 - Should return your registered workflow

### STEP 2: Create High-Value Order
### Run #30 - Copy instanceId from response

### STEP 3: Check Workflow Status
### Run #32 - Replace INSTANCE-ID
### Expected: status = "WAITING", current_step = "5"

### STEP 4: View in Monitor UI
### Open: http://localhost:3007/monitor
### Should see instance with WAITING status (orange)

### STEP 5: Approve via API
### Run #34 - Replace INSTANCE-ID and step_id
### Expected: Workflow continues execution

### STEP 6: Verify Completion
### Run #32 again - Status should now be "COMPLETED"

### STEP 7: Check in Customer UI
### Open: http://localhost:3008/order/ORDER-ID
### Should show "Order Confirmed!" message

### ============================================
### TESTING DIFFERENT SCENARIOS
### ============================================

### SCENARIO A: Happy Path (High-Value Order Approved)
# 1. Run #30 (Create high-value order)
# 2. Run #32 (Check status - should be WAITING)
# 3. Run #34 (Approve)
# 4. Run #32 (Check status - should be COMPLETED)

### SCENARIO B: Order Rejected
# 1. Run #30 (Create high-value order)
# 2. Run #32 (Check status - should be WAITING)
# 3. Run #35 (Reject)
# 4. Run #32 (Check status - should be FAILED or COMPLETED with rejection)

### SCENARIO C: Low-Value Order (Auto-Approved)
# 1. Run #31 (Create low-value order)
# 2. Run #32 (Check status - should be COMPLETED immediately)
# Note: No approval needed - workflow completes automatically

### SCENARIO D: Multiple Pending Approvals
# 1. Run #38 (Create order 1)
# 2. Run #39 (Create order 2)
# 3. Run #33 (List all instances - should show 2 WAITING)
# 4. Open Monitor UI - should see both in sidebar
# 5. Approve one by one

### ============================================
### TROUBLESHOOTING TESTS
### ============================================

### If workflow not triggering:
### Run #29 - Verify workflow is registered
### Run #45 - Check product service logs

### If status stays RUNNING:
### Run #44 - Verify workflow has user-task step
### Run #46 - Check execution service logs

### If approval doesn't work:
### Run #32 - Verify current_step matches step_id in approve request
### Check browser console (F12) for errors

### ============================================
### PERFORMANCE TESTING
### ============================================

### 47. Rapid Order Creation (10 orders)
# Run these in quick succession:
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}
{"customer_id": "perf-test-01", "items": [{"product": "Server", "quantity": 1, "price": 15000}], "total": 15000}
###
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}
{"customer_id": "perf-test-02", "items": [{"product": "Server", "quantity": 1, "price": 15000}], "total": 15000}
###
POST {{productService}}/api/orders
Content-Type: application/json
X-Tenant-ID: {{tenantId}}
{"customer_id": "perf-test-03", "items": [{"product": "Server", "quantity": 1, "price": 15000}], "total": 15000}

### 48. Check All Pending Instances
GET {{apiGateway}}/api/gateway/workflows/instances/recent?tenant_id={{tenantId}}&limit=20

### ============================================
### CLEANUP TESTS
### ============================================

### 49. List All Orders (For Cleanup Verification)
GET {{productService}}/api/orders
X-Tenant-ID: {{tenantId}}

### 50. List All Workflow Instances (For Cleanup Verification)
GET {{apiGateway}}/api/gateway/workflows/instances/recent?tenant_id={{tenantId}}&limit=50
